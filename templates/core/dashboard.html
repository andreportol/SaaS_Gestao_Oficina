{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div class="d-flex align-items-center gap-3">
        {% if request.user.empresa.logomarca_url %}
            <img class="report-logo" src="{{ request.user.empresa.logomarca_url }}" alt="Logomarca">
        {% endif %}
        <div>
            <h1 class="h4 mb-0 d-none d-sm-block">Dashboard</h1>
            <div class="small text-muted dashboard-muted">Resumo financeiro e operacional</div>
        </div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-end dashboard-filters">
        <div class="dashboard-filter dashboard-filter-range">
            <label class="small text-muted dashboard-muted" for="dashboardRange">Período</label>
            <select class="form-select form-select-sm" id="dashboardRange">
                <option value="30d"{% if dashboard_range == "30d" %} selected{% endif %}>Últimos 30 dias</option>
                <option value="90d"{% if dashboard_range == "90d" %} selected{% endif %}>Últimos 90 dias</option>
                <option value="6m"{% if dashboard_range == "6m" %} selected{% endif %}>Últimos 6 meses</option>
                <option value="12m"{% if dashboard_range == "12m" %} selected{% endif %}>Últimos 12 meses</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>
        <div class="dashboard-filter">
            <label class="small text-muted dashboard-muted" for="dashboardStart">Início</label>
            <input class="form-control form-control-sm" type="date" id="dashboardStart" />
        </div>
        <div class="dashboard-filter">
            <label class="small text-muted dashboard-muted" for="dashboardEnd">Fim</label>
            <input class="form-control form-control-sm" type="date" id="dashboardEnd" />
        </div>
        <button class="btn btn-cta btn-sm dashboard-filter-apply" id="dashboardApply">Aplicar</button>
    </div>
</div>

<div class="row g-3">
    <div class="col-6 col-md-3 d-flex">
        <a
            class="card p-3 text-center dashboard-stat-card dashboard-card w-100 text-decoration-none text-reset"
            href="{% url 'os_list' %}?status=ABERTA"
        >
            <div class="small text-muted d-flex align-items-center justify-content-center gap-1">
                OS Abertas
                <span class="dashboard-card-eye" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s4.5-6 10-6 10 6 10 6-4.5 6-10 6-10-6-10-6z"></path>
                        <circle cx="12" cy="12" r="3.5"></circle>
                    </svg>
                </span>
            </div>
            <div class="h4 mb-0">{{ os_abertas }}</div>
        </a>
    </div>
    <div class="col-6 col-md-3 d-flex">
        <a
            class="card p-3 text-center dashboard-stat-card dashboard-card w-100 text-decoration-none text-reset"
            href="{% url 'os_list' %}?status=AGUARDANDO_PECA"
        >
            <div class="small text-muted d-flex align-items-center justify-content-center gap-1">
                Aguardando Peças
                <span class="dashboard-card-eye" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s4.5-6 10-6 10 6 10 6-4.5 6-10 6-10-6-10-6z"></path>
                        <circle cx="12" cy="12" r="3.5"></circle>
                    </svg>
                </span>
            </div>
            <div class="h4 mb-0">{{ os_aguardando }}</div>
        </a>
    </div>
    <div class="col-6 col-md-3 d-flex">
        <a
            class="card p-3 text-center dashboard-stat-card dashboard-card w-100 text-decoration-none text-reset"
            href="{% url 'os_list' %}?status=EXECUCAO"
        >
            <div class="small text-muted d-flex align-items-center justify-content-center gap-1">
                Em Execução
                <span class="dashboard-card-eye" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s4.5-6 10-6 10 6 10 6-4.5 6-10 6-10-6-10-6z"></path>
                        <circle cx="12" cy="12" r="3.5"></circle>
                    </svg>
                </span>
            </div>
            <div class="h4 mb-0">{{ os_execucao }}</div>
        </a>
    </div>
    <div class="col-6 col-md-3 d-flex">
        <a
            class="card p-3 text-center dashboard-stat-card dashboard-card w-100 text-decoration-none text-reset"
            href="{% url 'os_list' %}?status=FINALIZADA"
        >
            <div class="small text-muted d-flex align-items-center justify-content-center gap-1">
                Finalizadas (30d)
                <span class="dashboard-card-eye" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s4.5-6 10-6 10 6 10 6-4.5 6-10 6-10-6-10-6z"></path>
                        <circle cx="12" cy="12" r="3.5"></circle>
                    </svg>
                </span>
            </div>
            <div class="h4 mb-0">{{ os_finalizadas_periodo }}</div>
        </a>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-12 col-lg-8">
        <div class="card p-3 dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 text-uppercase text-muted mb-0">Lucro mensal</h2>
                <div class="small text-muted">Entradas - Despesas</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="lucroChart" height="260"></canvas>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card p-3 dashboard-card">
            <div class="small text-muted">Saldo no período</div>
            <div class="h4 mb-0" id="saldoPeriodo">R$ 0,00</div>
        </div>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-12 col-lg-8">
        <a
            class="card p-3 dashboard-card dashboard-card-link text-decoration-none text-reset"
            href="{% url 'dashboard_os_por_funcionario' %}"
            aria-label="Ver tabela de OS por funcionário"
        >
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 text-uppercase text-muted mb-0">OS por funcionário</h2>
                <span class="dashboard-card-eye" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s4.5-6 10-6 10 6 10 6-4.5 6-10 6-10-6-10-6z"></path>
                        <circle cx="12" cy="12" r="3.5"></circle>
                    </svg>
                </span>
            </div>
            <div class="chart-wrapper">
                <canvas id="osFuncionarioChart" height="260"></canvas>
            </div>
        </a>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card p-3 dashboard-card">
            <h2 class="h6 text-uppercase text-muted mb-2">Status das OS</h2>
            <div class="chart-wrapper">
                <canvas id="osStatusChart" height="260"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-12 col-lg-7">
        <a
            class="card p-3 dashboard-card dashboard-card-link text-decoration-none text-reset"
            href="{% url 'dashboard_produtos_mais_vendidos' %}"
            aria-label="Ver tabela de produtos mais vendidos"
        >
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 text-uppercase text-muted mb-0">Produtos mais vendidos</h2>
                <div class="d-flex align-items-center gap-2">
                    <div class="d-flex align-items-center gap-2" id="produtosTopFilter">
                        <label class="small text-muted mb-0" for="produtosTopInput">Produtos</label>
                        <input
                            id="produtosTopInput"
                            type="number"
                            min="1"
                            step="1"
                            value="10"
                            class="form-control form-control-sm"
                            style="max-width: 90px;"
                            aria-label="Quantidade de produtos mais vendidos"
                        >
                    </div>
                    <span class="dashboard-card-eye" aria-hidden="true">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 12s4.5-6 10-6 10 6 10 6-4.5 6-10 6-10-6-10-6z"></path>
                            <circle cx="12" cy="12" r="3.5"></circle>
                        </svg>
                    </span>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="produtosChart" height="260"></canvas>
            </div>
        </a>
    </div>
    <div class="col-12 col-lg-5">
        <a
            class="card p-3 dashboard-card dashboard-card-link text-decoration-none text-reset"
            href="{% url 'dashboard_estoque_critico' %}"
            aria-label="Ver tabela de estoque crítico"
        >
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 text-uppercase text-muted mb-0">Estoque crítico</h2>
                <div class="d-flex align-items-center gap-2">
                    <span class="small text-muted"><span id="estoqueCriticoTotal">0</span> itens</span>
                    <span class="dashboard-card-eye" aria-hidden="true">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 12s4.5-6 10-6 10 6 10 6-4.5 6-10 6-10-6-10-6z"></path>
                            <circle cx="12" cy="12" r="3.5"></circle>
                        </svg>
                    </span>
                </div>
            </div>
            <div
                class="list-group list-group-flush"
                id="estoqueCriticoList"
                style="max-height: 260px; overflow-y: auto;"
            ></div>
        </a>
    </div>
</div>

<div class="row g-3 mt-1">
    <div class="col-12 col-lg-6">
        <div class="card p-3 dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 text-uppercase text-muted mb-0">Clientes mais lucrativos</h2>
                <div class="d-flex align-items-center gap-2">
                    <label class="small text-muted mb-0" for="clientesTopInput">Clientes</label>
                    <input
                        id="clientesTopInput"
                        type="number"
                        min="1"
                        step="1"
                        value="10"
                        class="form-control form-control-sm"
                        style="max-width: 90px;"
                        aria-label="Quantidade de clientes mais lucrativos"
                    >
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="clientesChart" height="260"></canvas>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="card p-3 dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 text-uppercase text-muted mb-0">Recorrência de clientes</h2>
                <div class="d-flex align-items-center gap-2">
                    <label class="small text-muted mb-0" for="recorrenciaTopInput">Clientes</label>
                    <input
                        id="recorrenciaTopInput"
                        type="number"
                        min="1"
                        step="1"
                        value="10"
                        class="form-control form-control-sm"
                        style="max-width: 90px;"
                        aria-label="Quantidade de clientes recorrentes"
                    >
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="recorrenciaChart" height="260"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{{ dashboard_data|json_script:"dashboard-data" }}
<script>
    window.addEventListener("load", function() {
        const dataSets = JSON.parse(document.getElementById("dashboard-data").textContent || "{}");
        let currentData = dataSets;
        const endpoint = "{% url 'dashboard_data' %}";
        const rangeSel = document.getElementById("dashboardRange");
        const startInput = document.getElementById("dashboardStart");
        const endInput = document.getElementById("dashboardEnd");
        const applyBtn = document.getElementById("dashboardApply");
        const themeToggle = document.getElementById("themeToggle");
        const produtosTopInput = document.getElementById("produtosTopInput");
        const produtosTopFilter = document.getElementById("produtosTopFilter");
        const clientesTopInput = document.getElementById("clientesTopInput");
        const recorrenciaTopInput = document.getElementById("recorrenciaTopInput");
        const charts = {};

        const formatCurrency = (value) =>
            `R$ ${Number(value || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
        const formatUnits = (value) => `${Number(value || 0)} Unidades`;
        const sanitizeLimit = (value, fallback = 10) => {
            const parsed = parseInt(value, 10);
            if (Number.isFinite(parsed) && parsed > 0) return parsed;
            return fallback;
        };
        const axisColor = () => (document.body.classList.contains("theme-light") ? "#000" : "#cbd5e1");
        const valueFromCtx = (ctx) => {
            if (ctx && typeof ctx.parsed === "object") {
                return Number(ctx.parsed.y ?? ctx.parsed.x ?? 0);
            }
            return Number(ctx?.parsed ?? 0);
        };
        const palette = [
            "rgba(14, 116, 144, 0.7)",
            "rgba(217, 119, 6, 0.7)",
            "rgba(37, 99, 235, 0.7)",
            "rgba(22, 163, 74, 0.7)",
            "rgba(220, 38, 38, 0.7)",
            "rgba(124, 58, 237, 0.7)",
            "rgba(8, 145, 178, 0.7)",
            "rgba(234, 88, 12, 0.7)",
            "rgba(79, 70, 229, 0.7)",
            "rgba(5, 150, 105, 0.7)",
        ];
        const borderPalette = palette.map((color) => color.replace("0.7", "1"));
        const buildColors = (size) => ({
            backgroundColor: Array.from({ length: size }, (_, i) => palette[i % palette.length]),
            borderColor: Array.from({ length: size }, (_, i) => borderPalette[i % borderPalette.length]),
        });
        const buildDynamicColors = (size, baseHue) => {
            const safeSize = Math.max(size, 1);
            const step = 360 / safeSize;
            const hues = Array.from({ length: size }, (_, i) => (baseHue + i * step) % 360);
            return {
                backgroundColor: hues.map((hue) => `hsla(${hue}, 72%, 55%, 0.7)`),
                borderColor: hues.map((hue) => `hsla(${hue}, 72%, 45%, 1)`),
            };
        };
        const getDistinctHues = () => {
            const base = Math.floor(Math.random() * 360);
            return {
                clientes: base,
                recorrencia: (base + 160) % 360,
            };
        };

        const setSaldoCards = (financeiro) => {
            const saldoPeriodo = document.getElementById("saldoPeriodo");
            if (saldoPeriodo) {
                saldoPeriodo.textContent = formatCurrency(financeiro.saldo_periodo);
                saldoPeriodo.classList.toggle("text-success", financeiro.saldo_periodo >= 0);
                saldoPeriodo.classList.toggle("text-danger", financeiro.saldo_periodo < 0);
            }
        };

        const ensureChart = (key, ctx, config) => {
            if (charts[key]) charts[key].destroy();
            charts[key] = new Chart(ctx, config);
        };

        const renderLucro = (data) => {
            const ctx = document.getElementById("lucroChart");
            const labels = data.labels || [];
            ensureChart("lucro", ctx, {
                type: "bar",
                data: {
                    labels,
                    datasets: [
                        {
                            type: "bar",
                            label: "Entradas",
                            data: data.entradas || [],
                            backgroundColor: "rgba(52, 211, 153, 0.6)",
                            borderColor: "rgba(52, 211, 153, 1)",
                        },
                        {
                            type: "bar",
                            label: "Despesas",
                            data: data.despesas || [],
                            backgroundColor: "rgba(239, 68, 68, 0.6)",
                            borderColor: "rgba(239, 68, 68, 1)",
                        },
                        {
                            type: "line",
                            label: "Lucro",
                            data: data.lucro || [],
                            borderColor: "rgba(59, 130, 246, 1)",
                            backgroundColor: "rgba(59, 130, 246, 0.3)",
                            tension: 0.35,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: axisColor() } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(valueFromCtx(ctx))}`,
                            },
                        },
                    },
                    scales: {
                        x: { ticks: { color: axisColor() } },
                        y: { ticks: { color: axisColor() }, beginAtZero: true },
                    },
                },
            });
        };

        const renderOsFuncionario = (data) => {
            const ctx = document.getElementById("osFuncionarioChart");
            ensureChart("osFuncionario", ctx, {
                type: "bar",
                data: {
                    labels: data.labels || [],
                    datasets: [
                        {
                            label: "OS",
                            data: data.valores || [],
                            backgroundColor: "rgba(59, 130, 246, 0.6)",
                            borderColor: "rgba(59, 130, 246, 1)",
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: axisColor() } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatUnits(valueFromCtx(ctx))}`,
                            },
                        },
                    },
                    scales: {
                        x: { ticks: { color: axisColor() } },
                        y: { ticks: { color: axisColor() }, beginAtZero: true },
                    },
                },
            });
        };

        const renderOsStatus = (data) => {
            const ctx = document.getElementById("osStatusChart");
            ensureChart("osStatus", ctx, {
                type: "doughnut",
                data: {
                    labels: data.labels || [],
                    datasets: [
                        {
                            data: data.valores || [],
                            backgroundColor: [
                                "rgba(251, 191, 36, 0.7)",
                                "rgba(59, 130, 246, 0.7)",
                                "rgba(244, 114, 182, 0.7)",
                                "rgba(52, 211, 153, 0.7)",
                                "rgba(15, 23, 42, 0.7)",
                            ],
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: axisColor() } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${formatUnits(valueFromCtx(ctx))}`,
                            },
                        },
                    },
                },
            });
        };

        const renderProdutos = (data) => {
            const ctx = document.getElementById("produtosChart");
            ensureChart("produtos", ctx, {
                type: "bar",
                data: {
                    labels: data.labels || [],
                    datasets: [
                        {
                            label: "Qtd",
                            data: data.qtd || [],
                            backgroundColor: "rgba(16, 185, 129, 0.6)",
                            borderColor: "rgba(16, 185, 129, 1)",
                            yAxisID: "y",
                        },
                        {
                            label: "Total (R$)",
                            data: data.total || [],
                            backgroundColor: "rgba(59, 130, 246, 0.6)",
                            borderColor: "rgba(59, 130, 246, 1)",
                            yAxisID: "y1",
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: axisColor() } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const value = valueFromCtx(ctx);
                                    if (ctx.dataset.label?.toLowerCase().includes("total")) {
                                        return `${ctx.dataset.label}: ${formatCurrency(value)}`;
                                    }
                                    return `${ctx.dataset.label}: ${formatUnits(value)}`;
                                },
                            },
                        },
                    },
                    scales: {
                        x: { ticks: { color: axisColor() } },
                        y: { ticks: { color: axisColor() }, beginAtZero: true, position: "left" },
                        y1: {
                            ticks: { color: axisColor() },
                            beginAtZero: true,
                            position: "right",
                            grid: { drawOnChartArea: false },
                        },
                    },
                },
            });
        };

        const renderClientes = (data, hue) => {
            const ctx = document.getElementById("clientesChart");
            const colors = buildDynamicColors((data.labels || []).length, hue ?? 210);
            ensureChart("clientes", ctx, {
                type: "bar",
                data: {
                    labels: data.labels || [],
                    datasets: [
                        {
                            label: "Faturamento",
                            data: data.valores || [],
                            backgroundColor: colors.backgroundColor,
                            borderColor: colors.borderColor,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: axisColor() } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(valueFromCtx(ctx))}`,
                            },
                        },
                    },
                    scales: {
                        x: { ticks: { color: axisColor() } },
                        y: { ticks: { color: axisColor() }, beginAtZero: true },
                    },
                },
            });
        };

        const renderRecorrencia = (data, hue) => {
            const ctx = document.getElementById("recorrenciaChart");
            const colors = buildDynamicColors((data.labels || []).length, hue ?? 30);
            ensureChart("recorrencia", ctx, {
                type: "bar",
                data: {
                    labels: data.labels || [],
                    datasets: [
                        {
                            label: "Vezes",
                            data: data.vezes || [],
                            backgroundColor: colors.backgroundColor,
                            borderColor: colors.borderColor,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: axisColor() } },
                        tooltip: {
                            callbacks: {
                                title: (items) => items?.[0]?.label || "",
                                label: (ctx) => `${valueFromCtx(ctx)} vezes`,
                            },
                        },
                    },
                    scales: {
                        x: { ticks: { color: axisColor() } },
                        y: { ticks: { color: axisColor() }, beginAtZero: true },
                    },
                },
            });
        };

        const renderEstoqueCritico = (data) => {
            const totalEl = document.getElementById("estoqueCriticoTotal");
            const listEl = document.getElementById("estoqueCriticoList");
            if (totalEl) totalEl.textContent = data.total || 0;
            if (!listEl) return;
            listEl.innerHTML = "";
            if (!data.itens || !data.itens.length) {
                listEl.innerHTML = '<div class="list-group-item small text-muted">Sem itens criticos.</div>';
                return;
            }
            data.itens.forEach((item) => {
                const row = document.createElement("div");
                row.className = "list-group-item d-flex justify-content-between align-items-center";
                row.innerHTML = `
                    <div>
                        <div class="fw-bold">${item.nome}</div>
                        <div class="small estoque-minimo-label">Minimo: <span class="estoque-minimo-value">${item.estoque_minimo ?? "-"}</span></div>
                    </div>
                    <span class="badge bg-danger-subtle text-danger-emphasis">${item.estoque_atual ?? "-"}</span>
                `;
                listEl.appendChild(row);
            });
        };

        const renderAll = (data) => {
            if (!data || !data.financeiro) return;
            const hues = getDistinctHues();
            setSaldoCards(data.financeiro);
            renderLucro(data.financeiro.lucro_mensal);
            renderOsFuncionario(data.operacional.os_por_funcionario);
            renderOsStatus(data.operacional.status_os);
            renderProdutos(data.produtos.mais_vendidos);
            renderEstoqueCritico(data.produtos.estoque_critico);
            renderClientes(data.clientes.mais_lucrativos, hues.clientes);
            renderRecorrencia(data.clientes.recorrencia, hues.recorrencia);
        };

        const setInputsFromData = (data) => {
            if (!data || !data.periodo) return;
            startInput.value = data.periodo.start;
            endInput.value = data.periodo.end;
        };

        const toggleCustomInputs = () => {
            const isCustom = rangeSel.value === "custom";
            startInput.disabled = !isCustom;
            endInput.disabled = !isCustom;
        };

        const fetchData = () => {
            const params = new URLSearchParams();
            if (produtosTopInput) {
                const limit = sanitizeLimit(produtosTopInput.value, 10);
                produtosTopInput.value = limit;
                params.set("produtos_top", limit);
            }
            if (clientesTopInput) {
                const limit = sanitizeLimit(clientesTopInput.value, 10);
                clientesTopInput.value = limit;
                params.set("clientes_top", limit);
            }
            if (recorrenciaTopInput) {
                const limit = sanitizeLimit(recorrenciaTopInput.value, 10);
                recorrenciaTopInput.value = limit;
                params.set("recorrencia_top", limit);
            }
            if (rangeSel.value && rangeSel.value !== "custom") {
                params.set("range", rangeSel.value);
            }
            if (rangeSel.value === "custom") {
                if (startInput.value) params.set("start", startInput.value);
                if (endInput.value) params.set("end", endInput.value);
            }
            const url = params.toString() ? `${endpoint}?${params.toString()}` : endpoint;
            fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
                .then((response) => response.json())
                .then((data) => {
                    currentData = data;
                    renderAll(data);
                    setInputsFromData(data);
                });
        };

        rangeSel.addEventListener("change", () => {
            toggleCustomInputs();
            if (rangeSel.value !== "custom") {
                fetchData();
            }
        });
        applyBtn.addEventListener("click", fetchData);
        produtosTopFilter?.addEventListener("click", (event) => event.stopPropagation());
        produtosTopFilter?.addEventListener("mousedown", (event) => event.stopPropagation());
        produtosTopInput?.addEventListener("change", fetchData);
        clientesTopInput?.addEventListener("change", fetchData);
        recorrenciaTopInput?.addEventListener("change", fetchData);
        themeToggle?.addEventListener("click", () => {
            setTimeout(() => renderAll(currentData), 0);
        });

        toggleCustomInputs();
        setInputsFromData(dataSets);
        renderAll(currentData);
    });
</script>
{% endblock %}
