{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ProjetoOficina</title>
    <meta name="theme-color" content="#0f172a">
    <link rel="icon" type="image/svg+xml" href="{% static 'core/favicon.svg' %}">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'core/styles.css' %}">
    {% block extra_head %}{% endblock %}
</head>
<body class="app-bg{% if user.is_authenticated %} is-authenticated{% endif %}{% if user.is_superuser %} is-superuser{% endif %}">
<div class="app-blob app-blob-1"></div>
<div class="app-blob app-blob-2"></div>
<nav class="navbar navbar-expand-lg navbar-dark app-nav py-3">
    <div class="container-xl">
        <a class="navbar-brand fw-bold" href="{% url 'dashboard' %}">
            {% if user.is_authenticated %}
                <span class="brand-mark" aria-label="Status online"></span>
            {% else %}
                <span class="brand-mark offline" aria-label="Status offline"></span>
            {% endif %}
            {% if user.is_authenticated and user.empresa %}
                {{ user.empresa.nome }}
            {% else %}
                √Årea Administrativa
            {% endif %}
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto nav-menu align-items-center">
                {% if user.is_authenticated %}
                <li class="nav-item">
                    <a class="nav-link nav-pill{% if request.resolver_match.url_name == 'clientes_list' or request.resolver_match.url_name == 'clientes_create' or request.resolver_match.url_name == 'clientes_update' %} active{% endif %}" href="{% url 'clientes_list' %}">Clientes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link nav-pill{% if request.resolver_match.url_name == 'veiculos_list' or request.resolver_match.url_name == 'veiculos_create' or request.resolver_match.url_name == 'veiculos_update' %} active{% endif %}" href="{% url 'veiculos_list' %}">Ve√≠culos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link nav-pill{% if request.resolver_match.url_name == 'agenda' %} active{% endif %}" href="{% url 'agenda' %}">Agenda</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link nav-pill{% if request.resolver_match.url_name == 'produtos_list' or request.resolver_match.url_name == 'produtos_create' or request.resolver_match.url_name == 'produtos_update' %} active{% endif %}" href="{% url 'produtos_list' %}">Produtos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link nav-pill{% if request.resolver_match.url_name == 'os_list' or request.resolver_match.url_name == 'os_create' or request.resolver_match.url_name == 'os_detail' or request.resolver_match.url_name == 'os_update' %} active{% endif %}" href="{% url 'os_list' %}">Ordens</a>
                </li>
                {% if user.is_gerente %}
                <li class="nav-item">
                    <a class="nav-link nav-pill{% if request.resolver_match.url_name == 'caixa' or request.resolver_match.url_name == 'caixa_graficos' %} active{% endif %}" href="{% url 'caixa' %}">Caixa</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link nav-pill{% if request.resolver_match.url_name == 'relatorios' %} active{% endif %}" href="{% url 'relatorios' %}">Relat√≥rios</a>
                </li>
                {% endif %}
                {% endif %}
            </ul>
            <ul class="navbar-nav align-items-center gap-3 nav-actions ms-3">
                {% if user.is_authenticated and user.is_gerente %}
                <li class="nav-item dropdown">
                    {% with url_name=request.resolver_match.url_name %}
                    <a class="nav-link nav-pill dropdown-toggle{% if url_name == 'usuarios_list' or url_name == 'usuarios_create' or url_name == 'usuarios_update' or url_name == 'funcionarios_list' or url_name == 'funcionarios_create' or url_name == 'funcionarios_update' %} active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Colaboradores</a>
                    {% endwith %}
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'usuarios_list' %}">Usu√°rios do Sistema</a></li>
                        <li><a class="dropdown-item" href="{% url 'funcionarios_list' %}">Funcion√°rios</a></li>
                    </ul>
                </li>
                {% endif %}
                {% if user.is_authenticated and user.is_superuser %}
                <li class="nav-item">
                    <a class="nav-link nav-pill{% if request.resolver_match.url_name == 'empresas_aprovacao' %} active{% endif %}" href="{% url 'empresas_aprovacao' %}">
                        Libera√ß√µes
                        {% if cadastros_pendentes_count %}
                            <span class="badge bg-danger ms-1">{{ cadastros_pendentes_count }}</span>
                        {% endif %}
                    </a>
                </li>
                {% endif %}
                {% if user.is_authenticated and user.is_superuser and renovacoes_pendentes_count %}
                <li class="nav-item">
                    <button class="btn btn-sm btn-nav position-relative" type="button" data-bs-toggle="collapse" data-bs-target="#renovacoesCollapse" aria-expanded="false" aria-controls="renovacoesCollapse" title="Notifica√ß√µes de renova√ß√£o">
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                            <path d="M12 22a2.5 2.5 0 0 0 2.45-2h-4.9A2.5 2.5 0 0 0 12 22zm7-6V11a7 7 0 1 0-14 0v5l-2 2v1h18v-1l-2-2z" fill="currentColor"/>
                        </svg>
                        <span class="badge bg-danger ms-1">{{ renovacoes_pendentes_count }}</span>
                    </button>
                </li>
                {% endif %}
                <li class="nav-item dropdown">
                    <a class="nav-link nav-pill dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Ajuda</a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'manual' %}">Manual</a></li>
                        <li><a class="dropdown-item" href="{% url 'manual' %}#videos">Ver V√≠deos</a></li>
                        {% if user.is_authenticated and user.is_gerente or user.is_superuser %}
                        <li><a class="dropdown-item" href="{% url 'empresa_update' %}">Atualizar dados</a></li>
                        {% endif %}
                        {% if user.is_authenticated and user.is_superuser %}
                        <li><a class="dropdown-item" href="/admin/">Admin</a></li>
                        {% endif %}
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#supportModal">Fale conosco</button></li>
                        {% if user.is_authenticated and user.is_gerente or user.is_superuser %}
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#planModal">Ver plano</button></li>
                        {% endif %}
                    </ul>
                </li>
                <li class="nav-item">
                    <button class="theme-toggle" id="themeToggle" type="button" aria-label="Alternar tema">üåô</button>
                </li>
                {% if user.is_authenticated %}
                    <li class="nav-item">
                        <span class="badge bg-soft badge-user">
                            Ol√°, {{ user.first_name }} {{ user.last_name }}{% if not user.first_name and not user.last_name %}{{ user.username }}{% endif %}
                        </span>
                    </li>
                    <li class="nav-item"><a class="btn btn-sm btn-nav" href="{% url 'logout' %}">Sair</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>
{% if user.is_authenticated and user.is_superuser and renovacoes_pendentes_count %}
    <div class="collapse" id="renovacoesCollapse">
        <div class="container-xl mt-3">
            <div class="alert alert-warning shadow-sm mb-0" role="alert">
                <div class="fw-bold">Pedidos de renova√ß√£o pendentes: {{ renovacoes_pendentes_count }}</div>
                <div class="small mt-1">
                    {% for empresa in renovacoes_pendentes %}
                        <div>
                            {{ empresa.nome }} ‚Äî {{ empresa.get_renovacao_periodo_display }}
                            {% if empresa.renovacao_solicitada_em %}
                                ({{ empresa.renovacao_solicitada_em|date:"d \\d\\e F \\d\\e Y \\√†\\s H:i" }})
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'empresas_aprovacao' %}">Ver solicita√ß√µes</a>
                </div>
            </div>
        </div>
    </div>
{% endif %}
<main class="container-xl app-content">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow-sm" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    {% if user.is_authenticated and user.empresa and user.empresa.is_ativo %}
        {% with dias=user.empresa.dias_para_vencimento %}
            {% if dias is not None and dias < 5 and dias >= 0 %}
                <div class="alert alert-warning shadow-sm" role="alert">
                    Seu acesso expira em {{ dias }} dia{{ dias|pluralize }}.
                </div>
            {% endif %}
        {% endwith %}
    {% endif %}
    {% block content %}{% endblock %}
</main>
<div class="modal fade" id="supportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contato com suporte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="supportForm" class="text-start">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Nome</label>
                        <input type="text" name="nome" class="form-control" required placeholder="Seu nome">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">E-mail</label>
                        <input type="email" name="email" class="form-control" required placeholder="seuemail@exemplo.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mensagem</label>
                        <textarea name="mensagem" class="form-control" rows="3" required placeholder="Explique o que aconteceu"></textarea>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Enviar</button>
                    </div>
                </form>
                <div class="alert alert-success d-none mt-3" id="supportSuccess">Mensagem enviada! Responderemos em breve.</div>
                <div class="alert alert-danger d-none mt-3" id="supportError"></div>
                <div class="d-flex justify-content-end mt-2 d-none" id="supportCloseWrap">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Plano da empresa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if user.is_authenticated and user.empresa %}
                    <div class="mb-3">
                        <div class="small text-muted">Plano atual</div>
                        <div class="fw-bold">{{ user.empresa.get_plano_display }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted">Atualizado em</div>
                        <div>{{ user.empresa.plano_atualizado_display|date:"d/m/Y" }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted">Vencimento</div>
                        <div>{{ user.empresa.plano_vencimento_calculado|date:"d/m/Y"|default:"-" }}</div>
                    </div>
                    {% if not user.empresa.renovacao_periodo %}
                        <div class="alert alert-info mt-3 d-flex align-items-center justify-content-between plan-last-renewal" id="plan-last-renewal">
                            <span>Renovado por √∫ltimo por {{ user.empresa.get_plano_periodo_display }}.</span>
                            <button type="button" class="btn-close" aria-label="Fechar" data-dismiss-last-renewal="true"></button>
                        </div>
                    {% endif %}
                    <div class="mt-3">
                        <div class="small text-muted mb-2">Renovar per√≠odo</div>
                        <form method="post" action="{% url 'empresa_renovar' %}" class="d-flex gap-2 align-items-center plan-renewal-controls">
                            {% csrf_token %}
                            <select name="periodo" class="form-select form-select-sm plan-renewal-select" id="renovacao-periodo-select">
                                {% for value, label, valor in user.empresa.periodos_com_valores %}
                                    <option value="{{ value }}" {% if user.empresa.plano_periodo == value %}selected{% endif %}>
                                        {{ label }} ‚Äî R$ {{ valor|floatformat:2 }}
                                    </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary btn-sm" {% if user.empresa.renovacao_periodo %}disabled aria-disabled="true"{% endif %}>
                                Solicitar renova√ß√£o
                            </button>
                        </form>
                        {% if user.empresa.renovacao_periodo %}
                            <div class="text-muted small mt-2">
                                Renova√ß√£o solicitada para {{ user.empresa.get_renovacao_periodo_display }}.
                                {% if user.empresa.renovacao_solicitada_em %}
                                    ({{ user.empresa.renovacao_solicitada_em|date:"d/m/Y" }})
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#planRenewalModal">
                                    Ver QR Pix
                                </button>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-muted">Nenhuma empresa vinculada.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="planRenewalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pagamento da renova√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if user.is_authenticated and user.empresa %}
                    {% if user.empresa.renovacao_periodo %}
                        <div class="small text-muted mb-2">
                            Renova√ß√£o solicitada para {{ user.empresa.get_renovacao_periodo_display }}.
                        </div>
                        {% with plano_valor=user.empresa.renovacao_plano_valor %}
                            {% if plano_valor and plano_valor.pix_qr_code %}
                                <div class="mt-3 text-center">
                                    <div class="small text-muted mb-2">Pagamento via Pix</div>
                                    <img src="{{ plano_valor.pix_qr_code.url }}" alt="QR Code Pix" class="plan-renewal-qr" width="120" height="120">
                                    {% if plano_valor.pix_copia_cola %}
                                        <div class="plan-renewal-copy-wrap mt-2">
                                            <textarea class="visually-hidden" id="pix-copia-cola">{{ plano_valor.pix_copia_cola }}</textarea>
                                            <a href="#" class="small text-muted" data-copy-target="pix-copia-cola">Copia e cola qrcode</a>
                                        </div>
                                    {% endif %}
                                </div>
                            {% elif plano_valor and plano_valor.pix_copia_cola %}
                                <div class="mt-3 text-center">
                                    <div class="plan-renewal-copy-wrap">
                                        <textarea class="visually-hidden" id="pix-copia-cola">{{ plano_valor.pix_copia_cola }}</textarea>
                                        <a href="#" class="small text-muted" data-copy-target="pix-copia-cola">Copia e cola qrcode</a>
                                    </div>
                                </div>
                            {% endif %}
                            {% if not plano_valor or not plano_valor.pix_qr_code and not plano_valor.pix_copia_cola %}
                                <div class="text-muted">Dados de pagamento indispon√≠veis.</div>
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        <div class="text-muted">Nenhuma renova√ß√£o pendente.</div>
                    {% endif %}
                {% else %}
                    <div class="text-muted">Nenhuma empresa vinculada.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function() {
        if (document.querySelector('[data-skip-autofocus="true"]')) {
            return;
        }
        const firstInput = document.querySelector('main input:not([type="hidden"]), main select, main textarea');
        if (firstInput && !firstInput.hasAttribute('autofocus')) {
            firstInput.focus();
        }
    })();

    (function() {
        const params = new URLSearchParams(window.location.search);
        if (!params.has("renovacao")) return;
        const modalEl = document.getElementById("planRenewalModal");
        if (!modalEl || typeof bootstrap === "undefined") return;
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
        params.delete("renovacao");
        const newQuery = params.toString();
        const newUrl = `${window.location.pathname}${newQuery ? `?${newQuery}` : ""}${window.location.hash}`;
        window.history.replaceState({}, "", newUrl);
    })();

    (function() {
        const storageKey = "hidePlanLastRenewal";
        const container = document.getElementById("plan-last-renewal");
        if (!container) return;
        if (localStorage.getItem(storageKey) === "1") {
            container.remove();
            return;
        }
        const closeBtn = container.querySelector("[data-dismiss-last-renewal]");
        if (!closeBtn) return;
        closeBtn.addEventListener("click", () => {
            localStorage.setItem(storageKey, "1");
            container.remove();
        });
    })();

    (function() {
        const buttons = document.querySelectorAll("[data-copy-target]");
        if (!buttons.length) return;
        const copyText = async (text) => {
            if (navigator.clipboard?.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            }
            return false;
        };

        buttons.forEach((button) => {
            button.addEventListener("click", async (event) => {
                event.preventDefault();
                const targetId = button.getAttribute("data-copy-target");
                const target = targetId ? document.getElementById(targetId) : null;
                const text = target?.value || target?.textContent || "";
                if (!text) return;
                let copied = false;
                try {
                    copied = await copyText(text);
                } catch (e) {
                    copied = false;
                }
                if (!copied) {
                    const temp = document.createElement("textarea");
                    temp.value = text;
                    temp.setAttribute("readonly", "");
                    temp.style.position = "absolute";
                    temp.style.left = "-9999px";
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand("copy");
                    document.body.removeChild(temp);
                }
                const original = button.textContent;
                button.textContent = "Copiado!";
                setTimeout(() => {
                    button.textContent = original;
                }, 1500);
            });
        });
    })();

    (function() {
        const body = document.body;
        const btn = document.getElementById('themeToggle');
        const stored = localStorage.getItem('theme');
        if (stored === 'light') {
            body.classList.add('theme-light');
        }
        updateIcon();

        function updateIcon() {
            if (!btn) return;
            const isLight = body.classList.contains('theme-light');
            btn.textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
            btn.setAttribute('aria-label', isLight ? 'Alternar para tema escuro' : 'Alternar para tema claro');
        }

        btn?.addEventListener('click', () => {
            const isLight = body.classList.toggle('theme-light');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateIcon();
        });
    })();

    (function() {
        const formatPhone = (value) => {
            const digits = value.replace(/\D/g, "").slice(0, 11);
            if (digits.length > 10) {
                return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`;
            }
            if (digits.length > 6) {
                return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`;
            }
            if (digits.length > 2) {
                return `(${digits.slice(0, 2)}) ${digits.slice(2)}`;
            }
            if (digits.length > 0) {
                return `(${digits}`;
            }
            return "";
        };

    const applyMask = (input) => {
        const allowEmail = input.dataset.allowEmail === "true";
        if (allowEmail && /[a-zA-Z@]/.test(input.value)) {
            return;
        }
        input.value = formatPhone(input.value);
    };

        const inputs = document.querySelectorAll(
            '[data-mask="phone"], input[name="telefone"], input[id="id_telefone"]'
        );
        inputs.forEach((input) => {
            applyMask(input);
            input.addEventListener("input", () => applyMask(input));
        });
    })();

    (function() {
        const formatCPF = (value) => {
            const digits = value.replace(/\D/g, "").slice(0, 11);
            if (digits.length > 9) {
                return `${digits.slice(0, 3)}.${digits.slice(3, 6)}.${digits.slice(6, 9)}-${digits.slice(9)}`;
            }
            if (digits.length > 6) {
                return `${digits.slice(0, 3)}.${digits.slice(3, 6)}.${digits.slice(6)}`;
            }
            if (digits.length > 3) {
                return `${digits.slice(0, 3)}.${digits.slice(3)}`;
            }
            return digits;
        };

        const isValidCPF = (digits) => {
            if (digits.length !== 11 || /^(\d)\1{10}$/.test(digits)) return false;
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += Number(digits[i]) * (10 - i);
            }
            let first = (sum * 10) % 11;
            first = first === 10 ? 0 : first;
            if (first !== Number(digits[9])) return false;

            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += Number(digits[i]) * (11 - i);
            }
            let second = (sum * 10) % 11;
            second = second === 10 ? 0 : second;
            return second === Number(digits[10]);
        };

        const setCPFValidity = (input, digits) => {
            if (!digits.length) {
                input.setCustomValidity("");
                return;
            }
            if (digits.length !== 11) {
                input.setCustomValidity("CPF deve ter 11 d√≠gitos.");
                return;
            }
            input.setCustomValidity(isValidCPF(digits) ? "" : "CPF inv√°lido.");
        };

        const applyCPFMask = (input) => {
            const digits = input.value.replace(/\D/g, "").slice(0, 11);
            input.value = formatCPF(digits);
            setCPFValidity(input, digits);
        };

        const inputs = document.querySelectorAll(
            '[data-mask="cpf"], input[name="documento"], input[id="id_documento"]'
        );
        inputs.forEach((input) => {
            applyCPFMask(input);
            input.addEventListener("input", () => applyCPFMask(input));
            input.addEventListener("blur", () => applyCPFMask(input));
        });
    })();

    (function() {
        const onlyDigits = (value) => value.replace(/\D/g, "");

        const formatCPF = (digits) => {
            if (digits.length > 9) {
                return `${digits.slice(0, 3)}.${digits.slice(3, 6)}.${digits.slice(6, 9)}-${digits.slice(9, 11)}`;
            }
            if (digits.length > 6) {
                return `${digits.slice(0, 3)}.${digits.slice(3, 6)}.${digits.slice(6)}`;
            }
            if (digits.length > 3) {
                return `${digits.slice(0, 3)}.${digits.slice(3)}`;
            }
            return digits;
        };

        const formatCNPJ = (digits) => {
            if (digits.length > 12) {
                return `${digits.slice(0, 2)}.${digits.slice(2, 5)}.${digits.slice(5, 8)}/${digits.slice(8, 12)}-${digits.slice(12, 14)}`;
            }
            if (digits.length > 8) {
                return `${digits.slice(0, 2)}.${digits.slice(2, 5)}.${digits.slice(5, 8)}/${digits.slice(8)}`;
            }
            if (digits.length > 5) {
                return `${digits.slice(0, 2)}.${digits.slice(2, 5)}.${digits.slice(5)}`;
            }
            if (digits.length > 2) {
                return `${digits.slice(0, 2)}.${digits.slice(2)}`;
            }
            return digits;
        };

        const isValidCPF = (digits) => {
            if (digits.length !== 11 || digits === digits[0].repeat(11)) return false;
            let total = 0;
            for (let i = 0; i < 9; i++) {
                total += Number(digits[i]) * (10 - i);
            }
            let first = (total * 10) % 11;
            first = first === 10 ? 0 : first;
            if (first !== Number(digits[9])) return false;
            total = 0;
            for (let i = 0; i < 10; i++) {
                total += Number(digits[i]) * (11 - i);
            }
            let second = (total * 10) % 11;
            second = second === 10 ? 0 : second;
            return second === Number(digits[10]);
        };

        const isValidCNPJ = (digits) => {
            if (digits.length !== 14 || digits === digits[0].repeat(14)) return false;
            const weightsFirst = [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            const weightsSecond = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            let total = 0;
            for (let i = 0; i < 12; i++) {
                total += Number(digits[i]) * weightsFirst[i];
            }
            let mod = total % 11;
            let first = mod < 2 ? 0 : 11 - mod;
            if (first !== Number(digits[12])) return false;
            total = 0;
            for (let i = 0; i < 13; i++) {
                total += Number(digits[i]) * weightsSecond[i];
            }
            mod = total % 11;
            const second = mod < 2 ? 0 : 11 - mod;
            return second === Number(digits[13]);
        };

        const setDocValidity = (input, digits) => {
            if (!digits.length) {
                input.setCustomValidity("");
                return;
            }
            if (digits.length === 11) {
                input.setCustomValidity(isValidCPF(digits) ? "" : "CPF inv√°lido.");
                return;
            }
            if (digits.length === 14) {
                input.setCustomValidity(isValidCNPJ(digits) ? "" : "CNPJ inv√°lido.");
                return;
            }
            input.setCustomValidity("Informe CPF (11 d√≠gitos) ou CNPJ (14 d√≠gitos).");
        };

        const applyDocMask = (input) => {
            const digits = onlyDigits(input.value).slice(0, 14);
            if (digits.length > 11) {
                input.value = formatCNPJ(digits);
            } else {
                input.value = formatCPF(digits);
            }
            setDocValidity(input, digits);
        };

        const inputs = document.querySelectorAll('[data-mask="cnpj-cpf"]');
        inputs.forEach((input) => {
            applyDocMask(input);
            input.addEventListener("input", () => applyDocMask(input));
            input.addEventListener("blur", () => applyDocMask(input));
        });
    })();

    (function() {
        const tipoSelect = document.querySelector('select[name="tipo"], #id_tipo');
        const marcaField = document.querySelector('input[name="marca"], select[name="marca"], #id_marca');
        if (!tipoSelect || !marcaField) return;

        let brandMap = {};
        try {
            brandMap = JSON.parse(marcaField.dataset.brands || "{}");
        } catch (e) {
            brandMap = {};
        }
        const placeholder = marcaField.dataset.placeholder || "Selecione a marca";
        const originalPlaceholder = marcaField.getAttribute("placeholder") || placeholder;

        const modeloField = document.querySelector('input[name="modelo"], #id_modelo');
        const modelPlaceholders = {
            CARRO: "Onix Plus",
            MOTO: "CG 160 Titan",
            CAMINHAO: "Scania Plus",
        };
        const dependentFields = Array.from(
            new Set([
                marcaField,
                ...document.querySelectorAll(
                    'input[name="modelo"], #id_modelo, input[name="ano"], #id_ano, input[name="cor"], #id_cor, input[name="placa"], #id_placa'
                ),
            ])
        );

        const setFieldEnabled = (field, enabled) => {
            field.disabled = !enabled;
            const isInput = field.tagName.toLowerCase() === "input";
            if (isInput) {
                if (!field.dataset.origPlaceholder) {
                    field.dataset.origPlaceholder = field.getAttribute("placeholder") || "";
                }
                field.setAttribute("placeholder", enabled ? field.dataset.origPlaceholder : "Selecione o tipo primeiro");
                if (!enabled) {
                    field.value = "";
                }
            } else if (!enabled) {
                field.value = "";
                field.innerHTML = "";
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "Selecione o tipo primeiro";
                field.appendChild(opt);
            }
        };

        const ensureDatalist = (inputEl) => {
            const listId = inputEl.getAttribute("list") || "marca-options";
            inputEl.setAttribute("list", listId);
            let datalist = document.getElementById(listId);
            if (!datalist) {
                datalist = document.createElement("datalist");
                datalist.id = listId;
                inputEl.insertAdjacentElement("afterend", datalist);
            }
            return datalist;
        };

        const renderSelectOptions = (selectEl, tipo, keepCurrent = true) => {
            const current = keepCurrent ? selectEl.value : "";
            const brands = brandMap[tipo] || [];
            selectEl.innerHTML = "";

            const placeholderOpt = document.createElement("option");
            placeholderOpt.value = "";
            placeholderOpt.textContent = placeholder;
            placeholderOpt.selected = !current;
            selectEl.appendChild(placeholderOpt);

            const options = [...brands];
            if (!options.includes("Outros")) options.push("Outros");

            options.forEach((brand) => {
                const opt = document.createElement("option");
                opt.value = brand;
                opt.textContent = brand;
                if (current === brand) opt.selected = true;
                selectEl.appendChild(opt);
            });

            if (current && !options.includes(current)) {
                const opt = document.createElement("option");
                opt.value = current;
                opt.textContent = current;
                opt.selected = true;
                selectEl.appendChild(opt);
            }
        };

        const renderInputOptions = (inputEl, tipo) => {
            const datalist = ensureDatalist(inputEl);
            const current = inputEl.value;
            const brands = brandMap[tipo] || [];
            const unique = Array.from(new Set([...brands, "Outros", current].filter(Boolean)));
            datalist.innerHTML = "";
            unique.forEach((brand) => {
                const opt = document.createElement("option");
                opt.value = brand;
                datalist.appendChild(opt);
            });
        };

        const setModeloPlaceholder = (tipo) => {
            if (!modeloField) return;
            const placeholder = modelPlaceholders[tipo];
            if (placeholder) {
                modeloField.setAttribute("placeholder", placeholder);
                modeloField.dataset.origPlaceholder = placeholder;
            }
        };

        const render = (keepCurrent = true) => {
            const tipo = tipoSelect.value;
            const enabled = Boolean(tipo);
            dependentFields.forEach((field) => setFieldEnabled(field, enabled));
            if (!tipo) return;

            setModeloPlaceholder(tipo);

            if (marcaField.tagName.toLowerCase() === "select") {
                renderSelectOptions(marcaField, tipo, keepCurrent);
            } else {
                renderInputOptions(marcaField, tipo);
            }
        };

        tipoSelect.addEventListener("change", () => {
            dependentFields.forEach((field) => {
                field.value = "";
            });
            render(false);
        });
        marcaField.addEventListener("focus", () => render(true));
        render(true);
    })();

    (function() {
        const inputs = document.querySelectorAll('[data-mask="ano-modelo"], input[name="ano"], #id_ano');
        if (!inputs.length) return;

        const formatAnoModelo = (value) => {
            const digits = value.replace(/\D/g, "").slice(0, 8);
            if (digits.length > 4) {
                return `${digits.slice(0, 4)}/${digits.slice(4)}`;
            }
            return digits;
        };

        inputs.forEach((input) => {
            input.addEventListener("input", () => {
                input.value = formatAnoModelo(input.value);
            });
        });
    })();

    (function() {
        const toIso = (value) => {
            const match = value.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (!match) return "";
            return `${match[3]}-${match[2]}-${match[1]}`;
        };

        const toBr = (value) => {
            const match = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!match) return "";
            return `${match[3]}/${match[2]}/${match[1]}`;
        };

        const inputs = document.querySelectorAll('input[data-date-picker="br"]');
        inputs.forEach((input) => {
            const proxy = document.createElement("input");
            proxy.type = "date";
            proxy.tabIndex = -1;
            proxy.setAttribute("aria-hidden", "true");
            proxy.className = "date-native-proxy";
            input.insertAdjacentElement("afterend", proxy);

            const initialIso = toIso(input.value);
            if (initialIso) {
                proxy.value = initialIso;
            }

            const openPicker = () => {
                if (input.disabled || input.readOnly) return;
                const syncIso = toIso(input.value);
                if (syncIso) {
                    proxy.value = syncIso;
                }
                if (typeof proxy.showPicker === "function") {
                    proxy.showPicker();
                } else {
                    proxy.focus({ preventScroll: true });
                    proxy.click();
                }
            };

            input.addEventListener("focus", openPicker);
            input.addEventListener("click", openPicker);

            proxy.addEventListener("change", () => {
                const value = toBr(proxy.value);
                if (value) {
                    input.value = value;
                }
            });

            input.addEventListener("blur", () => {
                const iso = toIso(input.value);
                if (iso) {
                    proxy.value = iso;
                    input.value = toBr(iso);
                } else if (!input.value.trim()) {
                    proxy.value = "";
                }
            });

            input.addEventListener("input", () => {
                if (!input.value.trim()) {
                    proxy.value = "";
                }
            });
        });
    })();

    (function() {
        const inputs = document.querySelectorAll('input[name="placa"], #id_placa');
        inputs.forEach((input) => {
            input.addEventListener("input", () => {
                if (input.disabled) return;
                const start = input.selectionStart ?? input.value.length;
                const end = input.selectionEnd ?? input.value.length;
                input.value = input.value.toUpperCase();
                input.setSelectionRange?.(start, end);
            });
        });
    })();

    (function() {
        const inputs = document.querySelectorAll('input[name="modelo"], #id_modelo');
        const toTitleCase = (value) =>
            value.replace(/\b(\S)(\S*)/g, (_, first, rest) => first.toUpperCase() + rest.toLowerCase());

        inputs.forEach((input) => {
            input.addEventListener("input", () => {
                if (input.disabled) return;
                const start = input.selectionStart ?? input.value.length;
                const end = input.selectionEnd ?? input.value.length;
                const formatted = toTitleCase(input.value);
                if (formatted !== input.value) {
                    input.value = formatted;
                    input.setSelectionRange?.(start, end);
                }
            });
        });
    })();

    (function() {
        const inputs = document.querySelectorAll('input[name="cor"], #id_cor');
        const formatCor = (value) => value.replace(/\b(\S)(\S*)/g, (_, first, rest) => first.toUpperCase() + rest.toLowerCase());

        inputs.forEach((input) => {
            input.addEventListener("input", () => {
                if (input.disabled) return;
                const start = input.selectionStart ?? input.value.length;
                const end = input.selectionEnd ?? input.value.length;
                const formatted = formatCor(input.value);
                if (formatted !== input.value) {
                    input.value = formatted;
                    input.setSelectionRange?.(start, end);
                }
            });
        });
    })();

    (function() {
        const clienteSelect = document.querySelector('select[name="cliente"], #id_cliente');
        const veiculoSelect = document.querySelector('select[name="veiculo"], #id_veiculo');
        if (!clienteSelect || !veiculoSelect) return;
        if (!veiculoSelect.dataset.vehicles) return;

        let vehiclesMap = {};
        try {
            vehiclesMap = JSON.parse(veiculoSelect.dataset.vehicles || "{}");
        } catch (e) {
            vehiclesMap = {};
        }
        const placeholder = veiculoSelect.dataset.placeholder || "Selecione o ve√≠culo do cliente";

        const renderVeiculos = (clienteId, keepCurrent = true) => {
            const current = keepCurrent ? veiculoSelect.value : "";
            veiculoSelect.innerHTML = "";

            const placeholderOpt = document.createElement("option");
            placeholderOpt.value = "";
            placeholderOpt.textContent = placeholder;
            placeholderOpt.selected = !current;
            veiculoSelect.appendChild(placeholderOpt);

            const options = vehiclesMap[clienteId] || [];
            options.forEach((v) => {
                const opt = document.createElement("option");
                opt.value = v.id;
                opt.textContent = v.label;
                if (String(current) === String(v.id)) opt.selected = true;
                veiculoSelect.appendChild(opt);
            });

            const hasValid = options.some((v) => String(v.id) === String(current));
            if (!hasValid) {
                veiculoSelect.value = "";
            }
            veiculoSelect.disabled = !clienteId;
        };

        clienteSelect.addEventListener("change", () => renderVeiculos(clienteSelect.value, false));
        renderVeiculos(clienteSelect.value || "", true);
    })();

    (function() {
        const moneyInputs = document.querySelectorAll('[data-format="currency2"]');

        const formatMoney = (input) => {
            const raw = input.value.replace(",", ".").replace(/[^\d.]/g, "");
            if (!raw) {
                input.value = "";
                return;
            }
            const num = parseFloat(raw);
            if (isNaN(num)) {
                input.value = "";
                return;
            }
            const clamped = Math.max(0, num);
            input.value = clamped.toFixed(2);
        };

        moneyInputs.forEach((input) => {
            input.addEventListener("blur", () => formatMoney(input));
        });

        const liveMoneyInputs = document.querySelectorAll('[data-format="currency2"][data-format-live="true"]');
        liveMoneyInputs.forEach((input) => {
            const formatLive = () => {
                const digits = input.value.replace(/\D/g, "");
                if (!digits) {
                    input.value = "";
                    return;
                }
                const cents = parseInt(digits, 10);
                if (Number.isNaN(cents)) {
                    input.value = "";
                    return;
                }
                input.value = (cents / 100).toFixed(2);
            };
            input.addEventListener("input", formatLive);
            formatLive();
        });
    })();

    (function() {
        const cepInputs = document.querySelectorAll('[data-mask="cep"], input[name="cep"], #id_cep');
        if (!cepInputs.length) return;

        const formatCEP = (value) => {
            const digits = value.replace(/\D/g, "").slice(0, 8);
            if (digits.length > 5) {
                return `${digits.slice(0, 5)}-${digits.slice(5)}`;
            }
            return digits;
        };

        const caretFromDigits = (formatted, digitsTarget) => {
            if (digitsTarget <= 0) return 0;
            let count = 0;
            for (let i = 0; i < formatted.length; i++) {
                if (/\d/.test(formatted[i])) count++;
                if (count >= digitsTarget) return i + 1;
            }
            return formatted.length;
        };

        const fillAddress = (data) => {
            const rua = document.querySelector('input[name="rua"], #id_rua');
            const bairro = document.querySelector('input[name="bairro"], #id_bairro');
            const cidade = document.querySelector('input[name="cidade"], #id_cidade');
            if (rua) rua.value = data?.logradouro || "";
            if (bairro) bairro.value = data?.bairro || "";
            if (cidade) cidade.value = data?.localidade || "";
        };

        const lookupCEP = async (cepValue, input) => {
            const digits = cepValue.replace(/\D/g, "");
            if (digits.length !== 8) return;
            if (input.dataset.lookup !== "viacep") return;
            try {
                const resp = await fetch(`https://viacep.com.br/ws/${digits}/json/`);
                if (!resp.ok) return;
                const data = await resp.json();
                if (!data.erro) {
                    fillAddress(data);
                }
            } catch (e) {
                // ignore lookup errors silently
            }
        };

        cepInputs.forEach((input) => {
            input.addEventListener("input", () => {
                const raw = input.value;
                const digitsBefore = raw.slice(0, input.selectionStart ?? raw.length).replace(/\D/g, "").length;
                input.value = formatCEP(raw).toUpperCase();
                const newPos = caretFromDigits(input.value, digitsBefore);
                if (!input.value.replace(/\D/g, "")) {
                    fillAddress({});
                }
                input.setSelectionRange?.(newPos, newPos);
            });
            input.addEventListener("blur", () => lookupCEP(input.value, input));
            // format initial value
            input.value = formatCEP(input.value).toUpperCase();
        });
    })();

    (function() {
        const btn = document.getElementById("btnLocate");
        if (!btn) return;

        const getVal = (name) => {
            const el = document.querySelector(`input[name="${name}"], #id_${name}`);
            return el ? el.value.trim() : "";
        };

        btn.addEventListener("click", () => {
            const parts = [getVal("rua"), getVal("numero"), getVal("bairro"), getVal("cidade"), getVal("cep")];
            const query = parts.filter(Boolean).join(", ");
            if (!query) return;
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
            window.open(url, "_blank");
        });
    })();

    (function() {
        const form = document.getElementById("supportForm");
        const successEl = document.getElementById("supportSuccess");
        const errorEl = document.getElementById("supportError");
        const closeWrap = document.getElementById("supportCloseWrap");
        const modalEl = document.getElementById("supportModal");
        const modal = modalEl ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;

        const getCSRFToken = () => {
            return (
                form?.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                document.cookie
                    .split(";")
                    .map((c) => c.trim())
                    .find((c) => c.startsWith("csrftoken="))
                    ?.split("=")[1] ||
                ""
            );
        };

        modalEl?.addEventListener("hidden.bs.modal", () => {
            successEl?.classList.add("d-none");
            errorEl?.classList.add("d-none");
            closeWrap?.classList.add("d-none");
        });

        form?.addEventListener("submit", async (ev) => {
            ev.preventDefault();
            successEl?.classList.add("d-none");
            errorEl?.classList.add("d-none");
            closeWrap?.classList.add("d-none");

            const payload = Object.fromEntries(new FormData(form).entries());
            try {
                const resp = await fetch("{% url 'contato_suporte' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken(),
                    },
                    body: JSON.stringify(payload),
                });
                const data = await resp.json();
                if (!resp.ok || !data.ok) {
                    throw new Error(data.error || "N√£o foi poss√≠vel enviar a mensagem.");
                }
                successEl?.classList.remove("d-none");
                closeWrap?.classList.remove("d-none");
                form.reset();
            } catch (err) {
                if (errorEl) {
                    errorEl.textContent = err.message || "Erro ao enviar.";
                    errorEl.classList.remove("d-none");
                    closeWrap?.classList.remove("d-none");
                } else {
                    alert(err.message || "Erro ao enviar.");
                }
            }
        });
    })();

    (function() {
        const normalize = (value) =>
            value
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");

        document.querySelectorAll('select[name="cliente"], select#id_cliente').forEach((select, index) => {
            if (select.dataset.clientSearch === "1") return;
            select.dataset.clientSearch = "1";
            const options = Array.from(select.options);
            if (!options.length) return;

            const placeholder = options.find((opt) => opt.value === "" || opt.disabled);
            const selected = options.find((opt) => opt.selected && opt.value);
            const datalistId = `cliente-datalist-${select.id || "field"}-${index}`;

            const input = document.createElement("input");
            input.type = "search";
            input.className = "form-control";
            input.placeholder = placeholder?.textContent?.trim() || "Digite o cliente...";
            input.autocomplete = "off";
            input.setAttribute("list", datalistId);

            const datalist = document.createElement("datalist");
            datalist.id = datalistId;

            const map = new Map();
            options.forEach((option) => {
                if (!option.value || option.disabled) return;
                const label = (option.textContent || "").trim();
                const key = normalize(label);
                if (!map.has(key)) {
                    map.set(key, option.value);
                }
                const opt = document.createElement("option");
                opt.value = label;
                datalist.appendChild(opt);
            });

            select.parentNode.insertBefore(input, select);
            select.parentNode.insertBefore(datalist, select);
            select.classList.add("d-none");
            select.setAttribute("aria-hidden", "true");

            if (selected) {
                input.value = (selected.textContent || "").trim();
            }

            const syncSelect = () => {
                const key = normalize(input.value.trim());
                const value = map.get(key) || "";
                if (select.value !== value) {
                    select.value = value;
                    select.dispatchEvent(new Event("change", {bubbles: true}));
                }
            };

            input.addEventListener("input", syncSelect);
            input.addEventListener("change", syncSelect);
            select.addEventListener("change", () => {
                const current = select.options[select.selectedIndex];
                input.value = (current?.textContent || "").trim();
            });
        });
    })();

    (function() {
        const toggler = document.querySelector(".navbar-toggler");
        const collapseEl = document.getElementById("navbarNav");
        if (!toggler || !collapseEl) return;

        let autoCollapseTimer = null;
        const collapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, {toggle: false});

        const clearTimer = () => {
            if (autoCollapseTimer) {
                clearTimeout(autoCollapseTimer);
                autoCollapseTimer = null;
            }
        };

        collapseEl.addEventListener("shown.bs.collapse", () => {
            clearTimer();
            autoCollapseTimer = setTimeout(() => collapse.hide(), 5000);
        });

        collapseEl.addEventListener("hide.bs.collapse", clearTimer);
    })();

    (function() {
        const compactPlaceholder = "Fa√ßa uma busca aqui";
        const selector = 'main input[type="search"][placeholder], main input[type="date"][placeholder]';

        const updatePlaceholders = () => {
            const useCompact = window.matchMedia("(max-width: 575.98px)").matches;
            document.querySelectorAll(selector).forEach((input) => {
                if (!input.dataset.placeholderDefault) {
                    input.dataset.placeholderDefault = input.getAttribute("placeholder") || "";
                }
                input.setAttribute(
                    "placeholder",
                    useCompact ? compactPlaceholder : input.dataset.placeholderDefault
                );
            });
        };

        updatePlaceholders();
        window.addEventListener("resize", updatePlaceholders);
    })();
</script>
{% block extra_js %}{% endblock %}
</body>
</html>
